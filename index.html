<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher App 3.0 - Class Hub Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#2563EB', 
                        secondary: '#10B981', 
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        dark: '#1F2937' 
                    } 
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .blur-screen { filter: blur(10px); pointer-events: none; user-select: none; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <div id="privacy-lock" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center hidden text-white">
        <i class="fa-solid fa-lock text-6xl mb-4 text-primary"></i>
        <h2 class="text-2xl font-bold">App Bloqueada</h2>
        <input type="password" id="unlock-pin" class="text-black text-center text-2xl p-2 rounded w-32 tracking-widest mt-4" maxlength="4">
        <button onclick="app.unlockApp()" class="mt-4 bg-primary px-6 py-2 rounded hover:bg-blue-600">Desbloquear</button>
    </div>

    <aside class="w-20 md:w-64 bg-white border-r flex flex-col z-20 transition-all duration-300">
        <div class="h-20 flex items-center justify-center border-b">
            <div class="flex items-center gap-2 font-bold text-xl text-primary">
                <i class="fa-solid fa-chalkboard-user text-2xl"></i>
                <span class="hidden md:inline">TEACHER<span class="text-gray-800">APP</span></span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-2 space-y-1" id="nav-menu">
            </nav>

        <div class="p-4 border-t bg-gray-50">
            <div id="user-profile" class="flex items-center gap-3 cursor-pointer" onclick="app.nav('settings')">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-lg">T</div>
                <div class="hidden md:block">
                    <p class="text-sm font-bold truncate" id="profile-name">Profesor</p>
                    <p class="text-xs text-green-500">‚óè En l√≠nea</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen relative">
        <header class="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-10">
            <h2 id="page-title" class="font-bold text-xl text-gray-700">Dashboard</h2>
            <div class="flex gap-3">
                <button onclick="app.togglePrivacy()" class="p-2 text-gray-500 hover:text-primary tooltip" title="Bloquear"><i class="fa-solid fa-lock"></i></button>
                <button onclick="app.saveData()" class="p-2 text-gray-500 hover:text-green-500 tooltip" title="Guardar Nube"><i class="fa-solid fa-cloud"></i></button>
            </div>
        </header>

        <div id="view-container" class="flex-1 overflow-auto p-6 bg-gray-100 relative">
            </div>
    </main>

    <script>
        // ==========================================
        // CONFIGURACI√ìN (PON TU ID AQUI)
        // ==========================================
        const CONFIG = {
            pantryId: '9df76c09-c878-45e6-9df9-7b02d9cd00ef', 
            basketName: 'TeacherAppV3'
        };

        const DEFAULT_DB = {
            profile: { name: "Profesor", school: "Mi Colegio", pin: "1234" },
            subjects: [],
            students: [],
            grades: [],
            behavior: [],
            rewardsLog: [],
            rewardPresets: [
                { label: "Tarea Completa", val: 5, icon: "üìù" },
                { label: "Participaci√≥n", val: 3, icon: "‚úã" }
            ],
            planning: [],
            schedule: { blocks: [] },
            alerts: []
        };

        const App = {
            data: null,
            currentView: 'dashboard',
            
            init: async function() {
                if(CONFIG.pantryId === 'PON_AQUI_TU_ID_REAL') {
                    Swal.fire('Falta Configuraci√≥n', 'Edita el c√≥digo HTML (L√≠nea 88) y pon tu ID de Pantry.', 'error');
                    return;
                }
                await this.loadData();
                this.renderMenu();
                this.nav('dashboard');
                
                document.getElementById('unlock-pin').addEventListener('keyup', (e) => {
                    if(e.key === 'Enter') this.unlockApp();
                });
            },

            loadData: async function() {
                try {
                    Swal.fire({title: 'Cargando...', didOpen: () => Swal.showLoading()});
                    const url = `https://getpantry.cloud/apiv1/pantry/${CONFIG.pantryId}/basket/${CONFIG.basketName}`;
                    const res = await fetch(url);
                    if(res.ok) {
                        this.data = await res.json();
                        this.data = { ...DEFAULT_DB, ...this.data }; 
                    } else {
                        this.data = JSON.parse(JSON.stringify(DEFAULT_DB));
                        await this.saveData(true);
                    }
                    Swal.close();
                    this.updateProfileUI();
                } catch (e) {
                    Swal.fire('Error', 'Modo Offline activado por error de red.', 'warning');
                    this.data = JSON.parse(JSON.stringify(DEFAULT_DB));
                }
            },

            saveData: async function(silent = false) {
                if(!silent) Swal.fire({title: 'Guardando...', didOpen: () => Swal.showLoading()});
                try {
                    const url = `https://getpantry.cloud/apiv1/pantry/${CONFIG.pantryId}/basket/${CONFIG.basketName}`;
                    await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.data)
                    });
                    if(!silent) Swal.fire({icon: 'success', title: 'Guardado', toast: true, position: 'top-end', timer: 1500, showConfirmButton: false});
                } catch (e) {
                    if(!silent) Swal.fire('Error', 'No se pudo guardar.', 'error');
                }
            },

            renderMenu: function() {
                const menu = [
                    { id: 'dashboard', icon: 'chart-pie', label: 'Dashboard', color: 'text-blue-500' },
                    { id: 'classes', icon: 'chalkboard', label: 'Mis Clases', color: 'text-indigo-600' }, // NUEVO
                    { id: 'schedule', icon: 'calendar-days', label: 'Horario', color: 'text-purple-500' },
                    { id: 'students', icon: 'users', label: 'Alumnos (Todos)', color: 'text-green-500' },
                    { id: 'planner', icon: 'book-open', label: 'Planeaci√≥n', color: 'text-orange-500' },
                    { id: 'grades', icon: 'graduation-cap', label: 'Notas', color: 'text-red-500' },
                    { id: 'behavior', icon: 'eye', label: 'Anecdotario', color: 'text-yellow-500' },
                    { id: 'settings', icon: 'gear', label: 'Ajustes', color: 'text-gray-500' }
                ];
                
                const nav = document.getElementById('nav-menu');
                nav.innerHTML = menu.map(m => `
                    <button onclick="app.nav('${m.id}')" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 transition flex items-center gap-4 text-gray-600 font-medium">
                        <i class="fa-solid fa-${m.icon} w-6 text-center ${m.color}"></i>
                        <span class="hidden md:inline">${m.label}</span>
                    </button>
                `).join('');
            },

            nav: function(viewId, param = null) {
                this.currentView = viewId;
                const container = document.getElementById('view-container');
                const title = document.getElementById('page-title');
                
                switch(viewId) {
                    case 'dashboard': this.renderDashboard(container); title.innerText = 'Dashboard'; break;
                    case 'classes': this.renderClasses(container); title.innerText = 'Mis Clases'; break;
                    case 'classDetail': this.renderClassDetail(container, param); title.innerText = 'Detalle de Clase'; break; // NUEVA VISTA
                    case 'schedule': this.renderSchedule(container); title.innerText = 'Horario Escolar'; break;
                    case 'students': this.renderStudents(container); title.innerText = 'Gesti√≥n Alumnos'; break;
                    case 'planner': this.renderPlanner(container); title.innerText = 'Planificador'; break;
                    case 'grades': this.renderGrades(container); title.innerText = 'Notas'; break;
                    case 'behavior': this.renderBehavior(container); title.innerText = 'Registro Anecd√≥tico'; break;
                    case 'settings': this.renderSettings(container); title.innerText = 'Configuraci√≥n'; break;
                }
            },

            // ==========================================
            // NUEVA SECCI√ìN: CLASES (CLASS HUB)
            // ==========================================

            renderClasses: function(c) {
                c.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                    ${this.data.subjects.map(s => `
                        <div onclick="app.nav('classDetail', '${s.id}')" class="card p-6 cursor-pointer hover:bg-${s.color}-50 border-t-4 border-${s.color}-500 group">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-xl text-gray-700 group-hover:text-${s.color}-600">${s.name}</h3>
                                <i class="fa-solid fa-arrow-right text-gray-300 group-hover:text-${s.color}-500"></i>
                            </div>
                            <div class="text-sm text-gray-500 space-y-2">
                                <p><i class="fa-solid fa-users w-6"></i> ${this.data.students.filter(st => st.subjectId === s.id).length} Alumnos</p>
                                <p><i class="fa-solid fa-calendar w-6"></i> ${this.data.planning.filter(p => p.subjectId === s.id).length} Planes</p>
                            </div>
                        </div>
                    `).join('')}
                    
                    <button onclick="app.addSubject()" class="border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 transition">
                        <i class="fa-solid fa-plus text-3xl mb-2"></i>
                        <span>Nueva Materia</span>
                    </button>
                </div>`;
            },

            // ESTA ES LA VISTA "TODO EN UNO" POR CLASE QUE PEDISTE
            renderClassDetail: function(c, subjectId) {
                const subj = this.data.subjects.find(s => s.id === subjectId);
                if(!subj) return this.nav('classes');

                // Filtros de datos para esta clase
                const students = this.data.students.filter(s => s.subjectId === subjectId);
                const plans = this.data.planning.filter(p => p.subjectId === subjectId).sort((a,b) => new Date(b.date) - new Date(a.date));
                const behaviors = this.data.behavior.filter(b => b.subjectId === subjectId || (b.subjectId === 'GLOBAL')).sort((a,b) => new Date(b.date) - new Date(a.date));
                
                // Filtro complejo: Logs de recompensas de alumnos QUE PERTENECEN a esta clase
                const studentIds = students.map(s => s.id);
                const rewards = this.data.rewardsLog.filter(r => studentIds.includes(r.studentId)).sort((a,b) => new Date(b.date) - new Date(a.date));

                c.innerHTML = `
                <div class="mb-6 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button onclick="app.nav('classes')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-arrow-left"></i> Volver</button>
                        <h2 class="text-2xl font-bold text-${subj.color}-600">${subj.name}</h2>
                    </div>
                    <button onclick="app.addStudent('${subjectId}')" class="bg-primary text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                        <i class="fa-solid fa-user-plus"></i> Agregar Alumno
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in h-[calc(100vh-180px)] overflow-y-auto">
                    
                    <div class="card p-4 flex flex-col h-96">
                        <h3 class="font-bold border-b pb-2 mb-2 text-gray-700"><i class="fa-solid fa-users text-blue-500"></i> Alumnos (${students.length})</h3>
                        <div class="overflow-y-auto flex-1 space-y-2">
                            ${students.map(s => `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded hover:bg-gray-100">
                                    <span class="font-medium">${s.name}</span>
                                    <div class="flex gap-2 text-xs">
                                        <span class="bg-blue-100 text-blue-700 px-2 rounded-full">XP: ${s.xp||0}</span>
                                        <button onclick="app.giveReward('${s.id}')" class="text-green-600 hover:text-green-800"><i class="fa-solid fa-gift"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                            ${students.length === 0 ? '<p class="text-center text-gray-400 mt-10">Sin alumnos.</p>' : ''}
                        </div>
                    </div>

                    <div class="card p-4 flex flex-col h-96">
                        <div class="flex justify-between border-b pb-2 mb-2">
                            <h3 class="font-bold text-gray-700"><i class="fa-solid fa-book text-orange-500"></i> Planificaci√≥n</h3>
                            <button onclick="app.addPlan('${subjectId}')" class="text-xs bg-orange-100 text-orange-600 px-2 rounded hover:bg-orange-200">+ Crear</button>
                        </div>
                        <div class="overflow-y-auto flex-1 space-y-3">
                            ${plans.map(p => `
                                <div class="border-l-4 border-orange-400 pl-3 py-1">
                                    <div class="font-bold text-sm">${p.topic}</div>
                                    <div class="text-xs text-gray-500">${p.date}</div>
                                    <div class="text-xs text-gray-600 mt-1 truncate">${p.objectives}</div>
                                </div>
                            `).join('')}
                             ${plans.length === 0 ? '<p class="text-center text-gray-400 mt-10">Nada planeado.</p>' : ''}
                        </div>
                    </div>

                    <div class="card p-4 flex flex-col h-96">
                        <h3 class="font-bold border-b pb-2 mb-2 text-gray-700"><i class="fa-solid fa-star text-yellow-500"></i> Historial Puntos</h3>
                        <div class="overflow-y-auto flex-1 text-sm">
                            <table class="w-full text-left">
                                <thead class="text-xs text-gray-400"><tr><th>Fecha</th><th>Alumno</th><th class="text-right">Pts</th></tr></thead>
                                <tbody>
                                    ${rewards.slice(0, 20).map(r => `
                                        <tr class="border-b">
                                            <td class="py-2 text-gray-500 text-xs">${new Date(r.date).toLocaleDateString()}</td>
                                            <td>${this.getStudentName(r.studentId)}</td>
                                            <td class="text-right font-mono ${r.amount>0?'text-green-600':'text-red-600'}">${r.amount>0?'+':''}${r.amount}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                             ${rewards.length === 0 ? '<p class="text-center text-gray-400 mt-10">Sin movimientos.</p>' : ''}
                        </div>
                    </div>

                    <div class="card p-4 flex flex-col h-96">
                        <div class="flex justify-between border-b pb-2 mb-2">
                            <h3 class="font-bold text-gray-700"><i class="fa-solid fa-triangle-exclamation text-red-500"></i> Incidencias</h3>
                             <button onclick="app.nav('behavior')" class="text-xs text-blue-500">Ver Completo</button>
                        </div>
                        <div class="overflow-y-auto flex-1 space-y-3">
                            ${behaviors.map(b => `
                                <div class="bg-gray-50 p-2 rounded text-sm relative pl-6">
                                    <span class="absolute left-2 top-3 w-2 h-2 rounded-full ${b.severity==='red'?'bg-red-500':b.severity==='yellow'?'bg-yellow-400':'bg-green-500'}"></span>
                                    <div class="flex justify-between font-bold text-gray-600">
                                        <span>${b.studentId==='GLOBAL' ? 'TODA LA CLASE' : this.getStudentName(b.studentId)}</span>
                                        <span class="text-xs font-normal">${b.date}</span>
                                    </div>
                                    <p class="text-gray-500 truncate">${b.desc}</p>
                                </div>
                            `).join('')}
                            ${behaviors.length === 0 ? '<p class="text-center text-gray-400 mt-10">Sin incidencias.</p>' : ''}
                        </div>
                    </div>

                </div>`;
            },

            // ==========================================
            // VISTAS STANDARD (ACTUALIZADAS)
            // ==========================================

            renderDashboard: function(c) {
                const today = new Date().toLocaleDateString('es-ES', {weekday: 'long'});
                const incidentCount = this.data.behavior.filter(b => new Date(b.date).toDateString() === new Date().toDateString()).length;
                
                c.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                    <div class="card p-6 border-l-4 border-blue-500">
                        <h3 class="font-bold text-gray-500 text-sm uppercase">Hoy es ${today}</h3>
                        <div class="mt-4 flex justify-between text-center">
                            <div><div class="text-2xl font-bold">${this.data.students.length}</div><div class="text-xs text-gray-400">Alumnos</div></div>
                            <div><div class="text-2xl font-bold text-red-500">${incidentCount}</div><div class="text-xs text-gray-400">Incidencias</div></div>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-bold text-gray-700 mb-4">Acciones R√°pidas</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="app.nav('classes')" class="bg-indigo-50 p-2 rounded text-indigo-600 hover:bg-indigo-100"><i class="fa-solid fa-chalkboard"></i> Mis Clases</button>
                            <button onclick="app.nav('behavior')" class="bg-yellow-50 p-2 rounded text-yellow-600 hover:bg-yellow-100"><i class="fa-solid fa-triangle-exclamation"></i> Incidencia</button>
                            <button onclick="app.nav('students')" class="bg-green-50 p-2 rounded text-green-600 hover:bg-green-100"><i class="fa-solid fa-star"></i> Puntos</button>
                            <button onclick="app.addAlert()" class="bg-gray-50 p-2 rounded text-gray-600 hover:bg-gray-100"><i class="fa-solid fa-note-sticky"></i> Nota</button>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-bold text-gray-700 mb-2">Agenda Hoy</h3>
                        <div class="space-y-2 text-sm max-h-40 overflow-y-auto">${this.getTodaysAgendaHTML()}</div>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 class="font-bold text-xl mb-4">Notas & Recordatorios</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                        ${this.data.alerts.map((a, i) => `
                            <div class="p-4 rounded shadow relative ${a.color || 'bg-yellow-100'} rotate-1 hover:rotate-0 transition">
                                <button onclick="app.delAlert(${i})" class="absolute top-1 right-1 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                                <p class="font-handwriting">${a.text}</p>
                            </div>
                        `).join('')}
                        <button onclick="app.addAlert()" class="border-2 border-dashed border-gray-300 rounded p-4 flex items-center justify-center text-gray-400 hover:border-blue-500">+ Nota</button>
                    </div>
                </div>`;
            },

            renderSchedule: function(c) {
                const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
                c.innerHTML = `
                <div class="flex justify-between mb-4">
                    <h3 class="font-bold text-xl">Horario Semanal</h3>
                    <button onclick="app.editScheduleMode()" class="bg-gray-800 text-white px-3 py-1 rounded text-sm"><i class="fa-solid fa-edit"></i> Editar Bloques</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    ${days.map(day => `
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="bg-gray-100 p-2 text-center font-bold border-b">${day}</div>
                            <div class="p-2 space-y-2 min-h-[200px]">${this.getScheduleBlocks(day)}</div>
                        </div>
                    `).join('')}
                </div>`;
            },

            getScheduleBlocks: function(day) {
                const blocks = this.data.schedule.blocks.filter(b => b.day === day).sort((a,b) => a.start.localeCompare(b.start));
                if(blocks.length === 0) return '<div class="text-xs text-gray-400 text-center py-4">Libre</div>';
                return blocks.map(b => {
                    const subj = this.data.subjects.find(s => s.id === b.subjectId) || {name: '?', color: 'gray'};
                    return `
                    <div onclick="app.openLinkedPlan('${b.subjectId}')" class="p-2 rounded border-l-4 text-xs cursor-pointer hover:brightness-95 transition bg-${subj.color}-100 border-${subj.color}-500">
                        <div class="font-bold flex justify-between"><span>${b.start} - ${b.end}</span></div>
                        <div class="mt-1 text-sm font-semibold">${subj.name}</div>
                    </div>`;
                }).join('');
            },

            renderPlanner: function(c) {
                const tabs = this.data.subjects.map(s => `<button onclick="app.renderPlannerList('${s.id}')" class="px-4 py-2 bg-white rounded-t-lg mr-1 border hover:bg-gray-50 focus:bg-blue-50 focus:border-blue-500 tab-btn" data-id="${s.id}">${s.name}</button>`).join('');
                c.innerHTML = `<div class="flex border-b mb-4 overflow-x-auto">${tabs}</div><div id="planner-content" class="bg-white p-6 rounded-b-lg shadow min-h-[400px]"><p class="text-gray-500 text-center mt-10">Selecciona materia.</p></div>`;
                if(this.data.subjects.length > 0) this.renderPlannerList(this.data.subjects[0].id);
            },

            renderPlannerList: function(subId) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('bg-blue-50', 'border-blue-500'));
                document.querySelector(`.tab-btn[data-id="${subId}"]`)?.classList.add('bg-blue-50', 'border-blue-500');
                const plans = this.data.planning.filter(p => p.subjectId === subId).sort((a,b) => new Date(b.date) - new Date(a.date));
                document.getElementById('planner-content').innerHTML = `
                <div class="flex justify-between mb-4"><h4 class="font-bold">Planes de Clase</h4><button onclick="app.addPlan('${subId}')" class="bg-blue-600 text-white px-3 py-1 rounded">+ Nueva Clase</button></div>
                <div class="space-y-4">${plans.map(p => `
                    <div class="border rounded-lg p-4 hover:shadow-md transition bg-gray-50">
                        <div class="flex justify-between border-b pb-2 mb-2"><span class="font-bold text-lg text-blue-600">${p.topic}</span><span class="text-sm text-gray-500">${p.date}</span></div>
                        <div class="text-sm"><strong>Obj:</strong> ${p.objectives}</div>
                        <div class="mt-2 text-right"><button onclick="app.delPlan('${p.id}','${subId}')" class="text-red-400 text-xs">Eliminar</button></div>
                    </div>`).join('')}</div>`;
            },

            renderGrades: function(c) {
                if(this.data.subjects.length === 0) return c.innerHTML = '<p class="text-center p-10">Agrega materias.</p>';
                c.innerHTML = `<div class="bg-white p-4 rounded shadow mb-4 flex gap-4 items-center"><label>Materia:</label><select id="grade-subject-sel" class="border p-2 rounded" onchange="app.renderGradesTable(this.value)">${this.data.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div><div id="grades-table-container" class="bg-white rounded shadow overflow-x-auto"></div>`;
                this.renderGradesTable(this.data.subjects[0].id);
            },

            renderGradesTable: function(subId) {
                const students = this.data.students.filter(s => s.subjectId === subId);
                document.getElementById('grades-table-container').innerHTML = `
                <table class="w-full text-left text-sm"><thead class="bg-gray-800 text-white"><tr><th class="p-3">Alumno</th><th class="p-3 text-center w-24">P1</th><th class="p-3 text-center w-24">P2</th><th class="p-3 text-center w-24">P3</th><th class="p-3 text-center w-24 bg-gray-900">Final</th><th class="p-3 text-center">Acci√≥n</th></tr></thead>
                <tbody>${students.map(s => {
                    const p1 = this.calcAvg(s.id, 1), p2 = this.calcAvg(s.id, 2), p3 = this.calcAvg(s.id, 3);
                    const final = ((parseFloat(p1)||0) + (parseFloat(p2)||0) + (parseFloat(p3)||0)) / 3;
                    return `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-medium">${s.name}</td><td class="p-3 text-center ${this.scoreColor(p1)}">${p1||'-'}</td><td class="p-3 text-center ${this.scoreColor(p2)}">${p2||'-'}</td><td class="p-3 text-center ${this.scoreColor(p3)}">${p3||'-'}</td><td class="p-3 text-center font-bold ${this.scoreColor(final.toFixed(1))}">${final>0?final.toFixed(1):'-'}</td><td class="p-3 text-center"><button onclick="app.addGrade('${s.id}')" class="text-blue-500 hover:bg-blue-100 p-1 rounded">Nota</button></td></tr>`;
                }).join('')}</tbody></table>`;
            },

            renderBehavior: function(c) {
                c.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 h-full">
                    <div class="bg-white p-4 rounded shadow h-full overflow-y-auto col-span-1">
                        <button onclick="app.renderBehaviorDetail('GLOBAL')" class="w-full text-left p-3 rounded mb-2 font-bold bg-gray-100">üåç Incidencia Global</button>
                        ${this.data.students.map(s => `<button onclick="app.renderBehaviorDetail('${s.id}')" class="w-full text-left p-2 rounded hover:bg-blue-50 text-sm border-b">${s.name}</button>`).join('')}
                    </div>
                    <div id="behavior-detail" class="col-span-3 bg-white p-6 rounded shadow overflow-y-auto"><p class="text-center text-gray-400 mt-20">Selecciona alumno.</p></div>
                </div>`;
            },

            renderBehaviorDetail: function(targetId) {
                const isGlobal = targetId === 'GLOBAL';
                const incidents = isGlobal ? this.data.behavior.filter(b => b.studentId === 'GLOBAL') : this.data.behavior.filter(b => b.studentId === targetId);
                document.getElementById('behavior-detail').innerHTML = `
                <div class="flex justify-between items-center mb-6 border-b pb-4"><h3 class="font-bold text-xl">${isGlobal ? 'Global' : this.getStudentName(targetId)}</h3><button onclick="app.addBehavior('${targetId}')" class="bg-primary text-white px-4 py-2 rounded">+ Nueva Incidencia</button></div>
                <div class="space-y-6 ml-4 pl-6 border-l-2 border-gray-200">${incidents.map(inc => `
                    <div class="relative mb-6"><span class="absolute -left-9 top-1 w-5 h-5 rounded-full border-2 border-white shadow ${inc.severity==='red'?'bg-red-500':inc.severity==='yellow'?'bg-yellow-400':'bg-green-500'}"></span>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border"><div class="flex justify-between text-xs text-gray-500"><span>${inc.date}</span><span>${this.getSubjectName(inc.subjectId)}</span></div><div class="flex gap-2 my-2">${inc.tags.map(t => `<span class="bg-white border px-1 rounded text-xs">${t}</span>`).join('')}</div><p>${inc.desc}</p></div></div>`).join('')}
                </div>`;
            },

            renderStudents: function(c) {
                c.innerHTML = `
                <div class="bg-white p-6 rounded shadow mb-6">
                    <div class="flex justify-between mb-4"><h3 class="font-bold">Todos los Alumnos</h3><div class="flex gap-2"><button onclick="app.addStudent()" class="bg-gray-200 px-3 py-1 rounded text-sm">Crear Alumno</button></div></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${this.data.students.map(s => `
                        <div class="card p-4 text-center group"><div class="font-bold">${s.name}</div><div class="text-xs text-gray-400 mb-2">${this.getSubjectName(s.subjectId)}</div><div class="flex justify-center gap-4 text-sm font-mono my-2"><div class="text-blue-600">XP: ${s.xp||0}</div><div class="text-green-600">$${s.wallet||0}</div></div><div class="opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="app.giveReward('${s.id}')" class="bg-green-500 text-white rounded py-1 px-2 text-xs">Premiar</button> <button onclick="app.redeem('${s.id}')" class="bg-orange-500 text-white rounded py-1 px-2 text-xs">Canjear</button></div></div>
                    `).join('')}</div>
                </div>`;
            },

            renderSettings: function(c) {
                c.innerHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold border-b pb-2 mb-4">Perfil</h3>
                        <input id="set-name" class="w-full border p-2 rounded mb-2" value="${this.data.profile.name}">
                        <button onclick="app.saveProfile()" class="bg-primary text-white px-4 py-2 rounded w-full">Guardar</button>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold border-b pb-2 mb-4">Materias Globales</h3>
                        <ul class="mb-4 space-y-2">${this.data.subjects.map(s => `<li class="flex justify-between bg-gray-50 p-2 rounded"><span class="text-${s.color}-600 font-bold">${s.name}</span><button onclick="app.delSubject('${s.id}')" class="text-red-400">x</button></li>`).join('')}</ul>
                        <button onclick="app.addSubject()" class="border border-dashed w-full p-2 text-gray-400 rounded hover:border-blue-500">+ Materia</button>
                    </div>
                </div>`;
            },

            // ==========================================
            // LOGICA / ACTIONS
            // ==========================================

            addStudent: async function(preselectedSubjectId = null) {
                if(this.data.subjects.length === 0) return Swal.fire('Alto', 'Primero crea una materia en Ajustes.', 'warning');
                
                const { value: name } = await Swal.fire({input: 'text', title: 'Nombre del Alumno'});
                if(!name) return;

                let subId = preselectedSubjectId;
                
                // Si no hay materia preseleccionada (venimos de vista general), preguntar:
                if(!subId) {
                    const options = {};
                    this.data.subjects.forEach(s => options[s.id] = s.name);
                    const { value: selected } = await Swal.fire({
                        title: 'Asignar a Clase',
                        input: 'select',
                        inputOptions: options,
                        showCancelButton: true
                    });
                    if(selected) subId = selected;
                }

                if(subId) {
                    this.data.students.push({ id: 'st-'+Date.now(), name, subjectId: subId, xp: 0, wallet: 0 });
                    this.saveData();
                    // Si est√°bamos en detalle de clase, recargar esa vista, si no, ir a lista general
                    if(preselectedSubjectId) this.renderClassDetail(document.getElementById('view-container'), preselectedSubjectId);
                    else this.nav('students');
                }
            },

            openLinkedPlan: async function(subjectId) {
                const todayStr = new Date().toISOString().split('T')[0];
                let plan = this.data.planning.find(p => p.subjectId === subjectId && p.date === todayStr);
                if(!plan) {
                    const r = await Swal.fire({title: 'Sin plan hoy', text: '¬øCrear uno nuevo?', showCancelButton: true, confirmButtonText: 'Crear'});
                    if(r.isConfirmed) { this.nav('classDetail', subjectId); } 
                    return;
                }
                Swal.fire({title: plan.topic, html: `<div class="text-left bg-gray-50 p-4 rounded text-sm"><p><strong>Obj:</strong> ${plan.objectives}</p><p><strong>Act:</strong> ${plan.activities}</p></div>`});
            },

            addPlan: async function(subId) {
                const { value: form } = await Swal.fire({
                    title: 'Planificar',
                    html: `<input id="sw-topic" class="swal2-input" placeholder="Tema"><input id="sw-date" type="date" class="swal2-input" value="${new Date().toISOString().split('T')[0]}"><textarea id="sw-obj" class="swal2-textarea" placeholder="Objetivos"></textarea><textarea id="sw-act" class="swal2-textarea" placeholder="Actividades"></textarea>`,
                    focusConfirm: false,
                    preConfirm: () => ({ topic: document.getElementById('sw-topic').value, date: document.getElementById('sw-date').value, objectives: document.getElementById('sw-obj').value, activities: document.getElementById('sw-act').value })
                });
                if(form && form.topic) {
                    this.data.planning.push({ id: Date.now(), subjectId: subId, ...form });
                    this.saveData();
                    // Recargar vista dependiendo donde estemos
                    if(this.currentView === 'classDetail') this.renderClassDetail(document.getElementById('view-container'), subId);
                    else this.renderPlannerList(subId);
                }
            },

            giveReward: async function(sId) {
                const presetsHtml = this.data.rewardPresets.map((p, idx) => `<button onclick="app.applyPreset('${sId}', ${idx})" class="m-1 p-2 border rounded hover:bg-blue-50">${p.icon} ${p.label}</button>`).join('');
                Swal.fire({
                    title: 'Asignar XP', html: `<div class="mb-4">${presetsHtml}</div><hr class="my-2"><input id="sw-pts" type="number" class="swal2-input" placeholder="Manual (+/-)"><input id="sw-rsn" class="swal2-input" placeholder="Raz√≥n">`,
                    showCancelButton: true, confirmButtonText: 'Guardar',
                    preConfirm: () => { const v = document.getElementById('sw-pts').value; if(v) this.processReward(sId, parseInt(v), document.getElementById('sw-rsn').value); }
                });
            },
            applyPreset: function(sId, pIdx) { const p = this.data.rewardPresets[pIdx]; this.processReward(sId, p.val, p.label); Swal.close(); },
            processReward: function(sId, amount, reason) {
                const s = this.data.students.find(st => st.id === sId);
                if(s) {
                    if(amount > 0) s.xp = (s.xp||0) + amount;
                    s.wallet = (s.wallet||0) + amount;
                    this.data.rewardsLog.push({ studentId: sId, amount, reason, date: new Date().toISOString() });
                    this.saveData();
                    // Actualizaci√≥n inteligente de UI
                    if(this.currentView === 'classDetail') this.renderClassDetail(document.getElementById('view-container'), s.subjectId);
                    else this.renderStudents(document.getElementById('view-container'));
                    Swal.fire('Listo', `${amount} pts.`, 'success');
                }
            },

            addBehavior: async function(studentId) {
                const { value: form } = await Swal.fire({
                    title: 'Incidencia',
                    html: `<select id="sw-sev" class="swal2-select"><option value="green">üü¢ Leve</option><option value="yellow">üü° Moderado</option><option value="red">üî¥ Grave</option></select><input id="sw-tag" class="swal2-input" placeholder="Etiquetas"><textarea id="sw-desc" class="swal2-textarea" placeholder="Descripci√≥n"></textarea><select id="sw-sub" class="swal2-input">${this.data.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>`,
                    preConfirm: () => ({ severity: document.getElementById('sw-sev').value, tags: document.getElementById('sw-tag').value.split(' '), desc: document.getElementById('sw-desc').value, subjectId: document.getElementById('sw-sub').value })
                });
                if(form && form.desc) {
                    this.data.behavior.push({ id: Date.now(), studentId, date: new Date().toISOString().split('T')[0], ...form });
                    this.saveData();
                    if(this.currentView === 'classDetail') {
                        // Si es global o del alumno en la vista actual, recargamos
                         const s = this.data.students.find(st => st.id === studentId);
                         if(studentId === 'GLOBAL' || s) this.renderClassDetail(document.getElementById('view-container'), form.subjectId);
                    } else {
                        this.renderBehaviorDetail(studentId);
                    }
                }
            },

            addGrade: async function(studentId) {
                const { value: form } = await Swal.fire({ title: 'Nota', html: `<select id="sw-p" class="swal2-input"><option value="1">P1</option><option value="2">P2</option><option value="3">P3</option></select><input id="sw-v" type="number" step="0.1" class="swal2-input" placeholder="Nota">`, preConfirm: () => [document.getElementById('sw-p').value, document.getElementById('sw-v').value] });
                if(form && form[1]) {
                    this.data.grades.push({ studentId, period: parseInt(form[0]), value: parseFloat(form[1]), date: new Date().toISOString() });
                    this.saveData();
                    this.renderGradesTable(this.data.students.find(s=>s.id===studentId).subjectId);
                }
            },

            // --- UTILS ---
            togglePrivacy: function() { document.getElementById('privacy-lock').classList.remove('hidden'); document.body.classList.add('blur-screen'); },
            unlockApp: function() { if(document.getElementById('unlock-pin').value === this.data.profile.pin) { document.getElementById('privacy-lock').classList.add('hidden'); document.body.classList.remove('blur-screen'); } else Swal.fire('Error', 'PIN Incorrecto', 'error'); },
            addSubject: async function() {
                const { value: name } = await Swal.fire({input: 'text', title: 'Nombre Materia'});
                if(name) {
                    const colors = ['blue', 'green', 'purple', 'orange', 'red', 'teal'];
                    this.data.subjects.push({ id: 's-'+Date.now(), name, color: colors[this.data.subjects.length % colors.length] });
                    this.saveData();
                    if(this.currentView === 'classes') this.renderClasses(document.getElementById('view-container'));
                    else this.renderSettings(document.getElementById('view-container'));
                }
            },
            addAlert: async function() { const { value: text } = await Swal.fire({input: 'text', title: 'Nota'}); if(text) { this.data.alerts.push({ text, color: 'bg-yellow-100' }); this.saveData(); this.renderDashboard(document.getElementById('view-container')); } },
            delAlert: function(i) { this.data.alerts.splice(i, 1); this.saveData(); this.renderDashboard(document.getElementById('view-container')); },
            editScheduleMode: async function() {
                 const { value: form } = await Swal.fire({ title: 'Bloque', html: `<select id="d" class="swal2-input"><option>Lunes</option><option>Martes</option><option>Mi√©rcoles</option><option>Jueves</option><option>Viernes</option></select><input id="s" type="time" class="swal2-input"><input id="e" type="time" class="swal2-input"><select id="sub" class="swal2-input">${this.data.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>`, preConfirm: () => ({ day: document.getElementById('d').value, start: document.getElementById('s').value, end: document.getElementById('e').value, subjectId: document.getElementById('sub').value }) });
                 if(form && form.start) { this.data.schedule.blocks.push(form); this.saveData(); this.renderSchedule(document.getElementById('view-container')); }
            },
            saveProfile: function() { this.data.profile.name = document.getElementById('set-name').value; this.saveData(); this.updateProfileUI(); },
            updateProfileUI: function() { document.getElementById('profile-name').innerText = this.data.profile.name; },
            calcAvg: function(sId, p) { const g = this.data.grades.filter(x => x.studentId === sId && x.period === p); if(!g.length) return ''; return (g.reduce((a,b)=>a+b.value,0)/g.length).toFixed(1); },
            scoreColor: function(v) { if(!v) return 'text-gray-400'; return parseFloat(v)<3.0?'text-red-600 font-bold':'text-gray-800'; },
            getSubjectName: function(id) { return this.data.subjects.find(s=>s.id===id)?.name || 'General'; },
            getStudentName: function(id) { return this.data.students.find(s=>s.id===id)?.name || 'Desconocido'; },
            getTodaysAgendaHTML: function() {
                const days = ['Domingo','Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const blocks = this.data.schedule.blocks.filter(b => b.day === days[new Date().getDay()]).sort((a,b)=>a.start.localeCompare(b.start));
                if(blocks.length === 0) return '<div class="text-gray-400 italic">Libre hoy.</div>';
                return blocks.map(b => `<div class="flex justify-between border-b pb-1"><span>${b.start} - ${this.getSubjectName(b.subjectId)}</span><button onclick="app.nav('classDetail', '${b.subjectId}')" class="text-blue-500 text-xs">Ir a clase</button></div>`).join('');
            }
        };

        window.onload = () => App.init();
        window.app = App;
    </script>
</body>
</html>