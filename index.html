<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher App 6.0 - Control Total</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#2563EB', secondary: '#10B981', danger: '#EF4444', dark: '#1F2937' 
                    } 
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-icon { transition: transform 0.1s; }
        .btn-icon:active { transform: scale(0.95); }
        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800 bg-gray-100">

    <div id="lock-screen" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center hidden text-white">
        <i class="fa-solid fa-lock text-5xl mb-4"></i>
        <input type="password" id="pin-input" class="text-black text-center text-2xl p-2 rounded w-40 tracking-widest" maxlength="4" placeholder="PIN">
        <button onclick="app.unlock()" class="mt-4 bg-primary px-6 py-2 rounded font-bold">Entrar</button>
    </div>

    <aside class="w-16 md:w-64 bg-white border-r flex flex-col z-20 transition-all duration-300">
        <div class="h-16 flex items-center justify-center border-b text-primary font-bold text-xl">
            <i class="fa-solid fa-graduation-cap md:mr-2"></i> <span class="hidden md:inline">TeacherApp v6</span>
        </div>
        <nav class="flex-1 overflow-y-auto p-2 space-y-1" id="nav-menu"></nav>
        <div class="p-3 border-t text-xs text-center text-gray-400">
            <div id="sync-status">‚óè Online</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen relative">
        <header class="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-10">
            <h2 id="page-title" class="font-bold text-xl text-gray-700">Panel</h2>
            <div class="flex gap-2">
                <button onclick="app.lock()" class="p-2 text-gray-400 hover:text-primary"><i class="fa-solid fa-lock"></i></button>
                <button onclick="app.sync()" class="p-2 text-gray-400 hover:text-green-500"><i class="fa-solid fa-cloud-arrow-up"></i></button>
            </div>
        </header>

        <div id="app-view" class="flex-1 overflow-auto p-4 md:p-6 relative"></div>
    </main>

    <script>
        // ==========================================
        // 1. CONFIGURACI√ìN
        // ==========================================
        const CONFIG = {
            pantryId: '9df76c09-c878-45e6-9df9-7b02d9cd00ef', // <--- IMPORTANTE: TU ID
            basketName: 'TeacherAppV6_Final'
        };

        const DB_TEMPLATE = {
            settings: { pin: '1234', name: 'Profesor', school: 'Escuela' },
            subjects: [],
            students: [],
            behavior: [],   // Anecdotario (Incidentes)
            rewardsLog: [], // Historial de Puntos/Compras
            planning: [],
            config: {
                points: [ // PRESETS EDITABLES
                    { label: "Tarea", val: 10, icon: "üìù" },
                    { label: "Participaci√≥n", val: 5, icon: "‚úã" },
                    { label: "Buen Comp.", val: 15, icon: "‚≠ê" }
                ],
                shop: [ // TIENDA EDITABLE
                    { name: "Punto Extra", cost: 100, icon: "üíØ" },
                    { name: "Dulce", cost: 50, icon: "üç¨" }
                ]
            }
        };

        // ==========================================
        // 2. L√ìGICA PRINCIPAL
        // ==========================================
        const App = {
            data: null,
            
            init: async function() {
                if(CONFIG.pantryId.includes('REAL')) return Swal.fire('Error', 'Falta ID en l√≠nea 74', 'error');
                await this.load();
                this.renderNav();
                this.nav('dashboard');
                // Enter en PIN
                document.getElementById('pin-input').addEventListener('keyup', (e)=> e.key==='Enter' && this.unlock());
            },

            // --- NUBE ---
            load: async function() {
                Swal.showLoading();
                try {
                    const r = await fetch(`https://getpantry.cloud/apiv1/pantry/${CONFIG.pantryId}/basket/${CONFIG.basketName}`);
                    if(r.ok) this.data = { ...DB_TEMPLATE, ...await r.json() };
                    else { this.data = JSON.parse(JSON.stringify(DB_TEMPLATE)); await this.sync(true); }
                    Swal.close();
                } catch(e) { 
                    this.data = JSON.parse(JSON.stringify(DB_TEMPLATE)); 
                    Swal.fire('Modo Offline', 'No se pudo conectar.', 'info'); 
                }
            },
            sync: async function(silent=false) {
                if(!silent) Swal.showLoading();
                try {
                    await fetch(`https://getpantry.cloud/apiv1/pantry/${CONFIG.pantryId}/basket/${CONFIG.basketName}`, {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(this.data)
                    });
                    if(!silent) Swal.fire({icon:'success', title:'Guardado', toast:true, position:'top-end', timer:1000, showConfirmButton:false});
                    document.getElementById('sync-status').innerText = '‚óè Sincronizado ' + new Date().toLocaleTimeString();
                } catch(e) { if(!silent) Swal.fire('Error', 'Fallo al guardar', 'error'); }
            },

            // --- NAVEGACI√ìN ---
            renderNav: function() {
                const opts = [
                    {id:'dashboard', t:'Inicio', i:'home'},
                    {id:'classes', t:'Mis Clases', i:'chalkboard-user'},
                    {id:'behavior', t:'Anecdotario Global', i:'book-skull'},
                    {id:'settings', t:'Ajustes', i:'gear'}
                ];
                document.getElementById('nav-menu').innerHTML = opts.map(o => `
                    <button onclick="app.nav('${o.id}')" class="w-full text-left p-3 rounded hover:bg-gray-100 text-gray-600 flex gap-3 items-center">
                        <i class="fa-solid fa-${o.i} w-6 text-center"></i> <span class="hidden md:inline">${o.t}</span>
                    </button>`).join('');
            },
            nav: function(view, param=null) {
                const c = document.getElementById('app-view');
                document.getElementById('page-title').innerText = view.toUpperCase();
                c.innerHTML = '';
                
                if(view === 'dashboard') this.viewDashboard(c);
                if(view === 'classes') this.viewClasses(c);
                if(view === 'classDetail') this.viewClassDetail(c, param);
                if(view === 'behavior') this.viewBehavior(c);
                if(view === 'settings') this.viewSettings(c);
            },

            // ==========================================
            // 3. VISTAS
            // ==========================================

            // --- DASHBOARD ---
            viewDashboard: function(c) {
                const totalSt = this.data.students.length;
                const totalInc = this.data.behavior.length;
                c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                        <div class="card p-6 border-l-4 border-blue-500">
                            <h3 class="text-gray-500 font-bold uppercase text-xs">Total Alumnos</h3>
                            <p class="text-3xl font-bold mt-2">${totalSt}</p>
                        </div>
                        <div class="card p-6 border-l-4 border-red-500">
                            <h3 class="text-gray-500 font-bold uppercase text-xs">Incidencias Totales</h3>
                            <p class="text-3xl font-bold mt-2 text-red-500">${totalInc}</p>
                            <button onclick="app.nav('behavior')" class="text-xs text-blue-500 mt-2 underline">Ver Anecdotario</button>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-gray-500 font-bold uppercase text-xs mb-3">Acceso R√°pido</h3>
                            <button onclick="app.nav('classes')" class="w-full bg-blue-600 text-white p-2 rounded mb-2">Ir a Clases</button>
                        </div>
                    </div>
                `;
            },

            // --- CLASES ---
            viewClasses: function(c) {
                c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                        ${this.data.subjects.map(s => `
                            <div onclick="app.nav('classDetail', '${s.id}')" class="card p-6 cursor-pointer hover:bg-blue-50 border-t-4 border-${s.color}-500 transition hover:shadow-lg">
                                <h3 class="font-bold text-xl">${s.name}</h3>
                                <p class="text-sm text-gray-500">${this.data.students.filter(x=>x.subjectId===s.id).length} Alumnos</p>
                            </div>
                        `).join('')}
                        <button onclick="app.addSubject()" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-gray-400 hover:border-blue-500 hover:text-blue-500 flex flex-col items-center justify-center">
                            <i class="fa-solid fa-plus text-2xl mb-2"></i> Crear Clase
                        </button>
                    </div>`;
            },

            // --- DETALLE CLASE (CORE) ---
            viewClassDetail: function(c, sId) {
                const s = this.data.subjects.find(x => x.id === sId);
                const students = this.data.students.filter(x => x.subjectId === sId);
                
                c.innerHTML = `
                <div class="flex flex-col h-full fade-in">
                    <div class="flex justify-between items-center mb-4 bg-white p-4 rounded shadow-sm">
                        <div class="flex items-center gap-3">
                            <button onclick="app.nav('classes')" class="text-gray-400 hover:text-dark"><i class="fa-solid fa-arrow-left"></i></button>
                            <h2 class="text-2xl font-bold text-${s.color}-600">${s.name}</h2>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.configRewards()" class="bg-gray-100 text-gray-600 px-3 py-2 rounded hover:bg-gray-200" title="Editar Premios"><i class="fa-solid fa-gear"></i> Premios</button>
                            <button onclick="app.addStudent('${sId}')" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700"><i class="fa-solid fa-plus"></i> Alumno</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pb-20">
                        ${students.map(st => `
                            <div class="card p-4 relative group">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-700 text-lg">${st.name.charAt(0)}</div>
                                        <div>
                                            <div class="font-bold text-lg leading-tight">${st.name}</div>
                                            <div class="text-xs text-gray-500">Nivel ${Math.floor((st.xp||0)/100)+1}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-xl text-green-600">$${st.wallet||0}</div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-4 gap-2 mt-4">
                                    <button onclick="app.uiGivePoints('${st.id}')" class="bg-green-50 text-green-600 p-2 rounded hover:bg-green-100 flex flex-col items-center text-xs">
                                        <i class="fa-solid fa-circle-plus text-lg mb-1"></i> Premiar
                                    </button>
                                    <button onclick="app.uiShop('${st.id}')" class="bg-purple-50 text-purple-600 p-2 rounded hover:bg-purple-100 flex flex-col items-center text-xs">
                                        <i class="fa-solid fa-cart-shopping text-lg mb-1"></i> Tienda
                                    </button>
                                    <button onclick="app.uiBehavior('${st.id}')" class="bg-yellow-50 text-yellow-600 p-2 rounded hover:bg-yellow-100 flex flex-col items-center text-xs">
                                        <i class="fa-solid fa-triangle-exclamation text-lg mb-1"></i> Reporte
                                    </button>
                                    <button onclick="app.uiHistory('${st.id}')" class="bg-blue-50 text-blue-600 p-2 rounded hover:bg-blue-100 flex flex-col items-center text-xs border border-blue-200">
                                        <i class="fa-solid fa-file-lines text-lg mb-1"></i> Historial
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            },

            // --- ANECDOTARIO / HISTORIAL ---
            viewBehavior: function(c) {
                // Vista Global de Incidencias
                const logs = this.data.behavior.sort((a,b) => new Date(b.date) - new Date(a.date));
                c.innerHTML = `
                    <div class="card p-6 max-w-4xl mx-auto">
                        <h3 class="font-bold text-xl mb-4 border-b pb-2">Anecdotario Global (Incidencias)</h3>
                        <div class="space-y-4">
                            ${logs.map(l => {
                                const st = this.data.students.find(s=>s.id===l.studentId);
                                return `
                                <div class="flex gap-4 p-3 bg-gray-50 rounded border-l-4 ${l.severity==='red'?'border-red-500':l.severity==='yellow'?'border-yellow-500':'border-green-500'}">
                                    <div class="text-xs text-gray-400 w-24">${l.date}</div>
                                    <div class="flex-1">
                                        <div class="font-bold">${st ? st.name : 'Desconocido'} <span class="font-normal text-sm bg-white border px-1 rounded ml-2">${l.severity}</span></div>
                                        <p class="text-gray-800">${l.desc}</p>
                                        <div class="text-xs text-gray-500 mt-1">${l.tags.map(t=>`#${t}`).join(' ')}</div>
                                    </div>
                                </div>`;
                            }).join('')}
                            ${logs.length===0 ? '<p class="text-gray-400 text-center">Sin incidencias registradas.</p>' : ''}
                        </div>
                    </div>`;
            },

            // --- AJUSTES ---
            viewSettings: function(c) {
                c.innerHTML = `
                <div class="max-w-2xl mx-auto space-y-6 fade-in">
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">Datos Generales</h3>
                        <input id="set-name" class="border p-2 w-full rounded mb-3" value="${this.data.settings.name}" placeholder="Nombre Profesor">
                        <button onclick="app.saveSettings()" class="bg-primary text-white px-4 py-2 rounded">Guardar</button>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">Configuraci√≥n de Aula</h3>
                        <button onclick="app.configRewards()" class="w-full text-left p-3 border rounded hover:bg-gray-50 mb-2 flex justify-between">
                            <span>Editar Botones de Puntos y Tienda</span> <i class="fa-solid fa-chevron-right"></i>
                        </button>
                        <button onclick="app.exportExcel()" class="w-full text-left p-3 border rounded hover:bg-green-50 text-green-700 flex justify-between">
                            <span>Descargar Reporte Excel Completo</span> <i class="fa-solid fa-file-excel"></i>
                        </button>
                    </div>
                    <div class="card p-6 border-red-100 bg-red-50">
                        <h3 class="font-bold text-red-600 mb-2">Zona de Peligro</h3>
                        <button onclick="app.resetAll()" class="text-red-500 underline text-sm">Borrar todos los datos</button>
                    </div>
                </div>`;
            },

            // ==========================================
            // 4. MODALES Y ACCIONES (LO IMPORTANTE)
            // ==========================================

            // A. PREMIAR (CON CAMPO LIBRE)
            uiGivePoints: async function(sId) {
                const s = this.data.students.find(x => x.id === sId);
                
                // Generar HTML de botones preestablecidos
                const buttons = this.data.config.points.map((p, idx) => `
                    <button onclick="app.applyPoints('${sId}', ${p.val}, '${p.label}')" 
                        class="p-3 bg-white border rounded shadow-sm hover:bg-blue-50 hover:border-blue-300 transition text-left flex items-center justify-between group">
                        <span><span class="text-xl mr-2">${p.icon}</span> ${p.label}</span>
                        <span class="font-bold text-blue-600 bg-blue-50 px-2 rounded group-hover:bg-white">+${p.val}</span>
                    </button>
                `).join('');

                await Swal.fire({
                    title: `Premiar a ${s.name}`,
                    html: `
                        <div class="grid grid-cols-1 gap-2 mb-4 max-h-60 overflow-y-auto p-1 bg-gray-50 rounded">
                            ${buttons}
                        </div>
                        <hr class="my-3">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-bold text-gray-500 text-left">Puntaje Manual (Cualquier valor):</label>
                            <div class="flex gap-2">
                                <input type="number" id="manual-pts" class="swal2-input m-0 flex-1" placeholder="Ej: 50 o -20">
                                <input type="text" id="manual-reason" class="swal2-input m-0 flex-1" placeholder="Motivo">
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Aplicar Manual',
                    showCancelButton: true,
                    preConfirm: () => {
                        const val = parseInt(document.getElementById('manual-pts').value);
                        const rsn = document.getElementById('manual-reason').value || 'Manual';
                        if(!isNaN(val)) return app.applyPoints(sId, val, rsn);
                    }
                });
            },

            applyPoints: function(sId, amount, reason) {
                const s = this.data.students.find(x => x.id === sId);
                if(s) {
                    s.xp = (s.xp || 0) + amount; // XP siempre suma (o resta si es negativo)
                    s.wallet = (s.wallet || 0) + amount; // Billetera igual
                    
                    // LOG
                    this.data.rewardsLog.push({
                        type: 'point',
                        studentId: sId,
                        amount: amount,
                        reason: reason,
                        date: new Date().toLocaleString()
                    });
                    
                    this.sync(); // Guardar
                    this.nav('classDetail', s.subjectId); // Refrescar
                    Swal.close();
                    const icon = amount >= 0 ? 'success' : 'warning';
                    Swal.fire({icon: icon, title: `${amount > 0 ? '+' : ''}${amount} pts`, text: reason, timer: 1500, showConfirmButton: false});
                }
            },

            // B. TIENDA
            uiShop: function(sId) {
                const s = this.data.students.find(x => x.id === sId);
                const items = this.data.config.shop.map(item => {
                    const canBuy = s.wallet >= item.cost;
                    return `
                    <div onclick="${canBuy ? `app.buyItem('${sId}', ${item.cost}, '${item.name}')` : ''}" 
                         class="flex justify-between items-center p-3 border rounded mb-2 ${canBuy ? 'hover:bg-green-50 cursor-pointer' : 'opacity-50 bg-gray-100'}">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${item.icon}</span>
                            <div class="text-left leading-tight">
                                <div class="font-bold text-sm">${item.name}</div>
                                <div class="text-xs text-gray-500">Costo: ${item.cost}</div>
                            </div>
                        </div>
                        ${canBuy ? '<i class="fa-solid fa-bag-shopping text-green-500"></i>' : '<i class="fa-solid fa-lock text-gray-400"></i>'}
                    </div>`;
                }).join('');

                Swal.fire({
                    title: `Tienda (Saldo: $${s.wallet})`,
                    html: `<div class="max-h-80 overflow-y-auto">${items}</div>`,
                    showConfirmButton: false
                });
            },

            buyItem: function(sId, cost, name) {
                const s = this.data.students.find(x => x.id === sId);
                s.wallet -= cost;
                this.data.rewardsLog.push({
                    type: 'shop',
                    studentId: sId,
                    amount: -cost,
                    reason: `Compr√≥: ${name}`,
                    date: new Date().toLocaleString()
                });
                this.sync();
                this.nav('classDetail', s.subjectId);
                Swal.fire('¬°Comprado!', `Disfruta tu ${name}`, 'success');
            },

            // C. ANECDOTARIO INDIVIDUAL (CONDUCTA)
            uiBehavior: async function(sId) {
                const { value: form } = await Swal.fire({
                    title: 'Reportar Conducta',
                    html: `
                        <select id="swal-sev" class="swal2-select w-full mb-2">
                            <option value="green">üü¢ Leve (Advertencia)</option>
                            <option value="yellow">üü° Moderada</option>
                            <option value="red">üî¥ Grave</option>
                        </select>
                        <textarea id="swal-desc" class="swal2-textarea w-full" placeholder="Describe lo sucedido..."></textarea>
                        <input id="swal-tags" class="swal2-input w-full" placeholder="Etiquetas (ej: respeto tarea)">
                    `,
                    focusConfirm: false,
                    preConfirm: () => {
                        return {
                            severity: document.getElementById('swal-sev').value,
                            desc: document.getElementById('swal-desc').value,
                            tags: document.getElementById('swal-tags').value
                        }
                    }
                });

                if (form && form.desc) {
                    this.data.behavior.push({
                        id: Date.now(),
                        studentId: sId,
                        date: new Date().toLocaleString(), // Guardamos fecha y hora
                        severity: form.severity,
                        desc: form.desc,
                        tags: form.tags.split(' ').filter(t => t)
                    });
                    this.sync();
                    Swal.fire('Registrado', 'Incidencia guardada en el historial.', 'success');
                }
            },

            // D. HISTORIAL UNIFICADO (EL EXPEDIENTE)
            uiHistory: function(sId) {
                const s = this.data.students.find(x => x.id === sId);
                
                // 1. Obtener logs de puntos/tienda
                const pointLogs = this.data.rewardsLog.filter(x => x.studentId === sId).map(x => ({...x, category: 'wallet'}));
                
                // 2. Obtener logs de conducta
                const behaviorLogs = this.data.behavior.filter(x => x.studentId === sId).map(x => ({
                    date: x.date,
                    reason: x.desc,
                    amount: null,
                    category: 'behavior',
                    severity: x.severity,
                    tags: x.tags
                }));

                // 3. Unir y ordenar por fecha (m√°s reciente primero)
                // Nota: Usamos Date.parse para ordenar, asumiendo formato localString standard
                const allLogs = [...pointLogs, ...behaviorLogs].sort((a,b) => {
                     // Intento simple de ordenamiento de strings de fecha
                     return a.date < b.date ? 1 : -1; 
                });

                // 4. Generar tabla HTML
                const rows = allLogs.map(log => {
                    let iconHTML = '';
                    let colorClass = '';
                    let amountHTML = '';

                    if (log.category === 'wallet') {
                        if (log.type === 'shop') {
                            iconHTML = '<i class="fa-solid fa-cart-shopping text-purple-500"></i>';
                            amountHTML = `<span class="text-red-500 font-bold">${log.amount}</span>`;
                        } else {
                            iconHTML = '<i class="fa-solid fa-star text-yellow-500"></i>';
                            amountHTML = `<span class="text-${log.amount >= 0 ? 'green' : 'red'}-500 font-bold">${log.amount > 0 ? '+' : ''}${log.amount}</span>`;
                        }
                    } else {
                        // Conducta
                        const color = log.severity === 'red' ? 'text-red-600' : (log.severity === 'yellow' ? 'text-yellow-500' : 'text-green-500');
                        iconHTML = `<i class="fa-solid fa-triangle-exclamation ${color}"></i>`;
                        amountHTML = `<span class="text-xs border px-1 rounded">Reporte</span>`;
                    }

                    return `
                        <tr class="border-b hover:bg-gray-50 text-sm">
                            <td class="p-2 text-gray-500 text-xs w-24">${log.date.split(',')[0]}</td>
                            <td class="p-2 text-center w-10">${iconHTML}</td>
                            <td class="p-2">
                                <div class="font-medium">${log.reason}</div>
                                ${log.tags ? `<div class="text-xs text-gray-400">${log.tags.map(t=>'#'+t).join(' ')}</div>` : ''}
                            </td>
                            <td class="p-2 text-right">${amountHTML}</td>
                        </tr>
                    `;
                }).join('');

                Swal.fire({
                    title: `Historial: ${s.name}`,
                    width: '600px',
                    html: `
                        <div class="bg-white rounded border overflow-hidden">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                                    <tr>
                                        <th class="p-2">Fecha</th>
                                        <th class="p-2 text-center">Tipo</th>
                                        <th class="p-2">Detalle</th>
                                        <th class="p-2 text-right">Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows.length ? rows : '<tr><td colspan="4" class="p-4 text-center text-gray-400">Historial vac√≠o</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `
                });
            },

            // E. CONFIGURAR PREMIOS (EDITAR PRESETS)
            configRewards: async function() {
                // Generar lista editable
                const pointsList = this.data.config.points.map((p,i) => `
                    <div class="flex gap-2 mb-2 items-center">
                        <input id="p-icon-${i}" value="${p.icon}" class="border w-10 text-center p-1 rounded">
                        <input id="p-label-${i}" value="${p.label}" class="border flex-1 p-1 rounded">
                        <input id="p-val-${i}" value="${p.val}" type="number" class="border w-16 p-1 rounded">
                        <button onclick="app.delPreset('points', ${i})" class="text-red-500 px-2">√ó</button>
                    </div>
                `).join('');

                const shopList = this.data.config.shop.map((p,i) => `
                    <div class="flex gap-2 mb-2 items-center">
                        <input id="s-icon-${i}" value="${p.icon}" class="border w-10 text-center p-1 rounded">
                        <input id="s-name-${i}" value="${p.name}" class="border flex-1 p-1 rounded">
                        <input id="s-cost-${i}" value="${p.cost}" type="number" class="border w-16 p-1 rounded">
                        <button onclick="app.delPreset('shop', ${i})" class="text-red-500 px-2">√ó</button>
                    </div>
                `).join('');

                const { isConfirmed } = await Swal.fire({
                    title: 'Configurar Premios y Tienda',
                    html: `
                        <div class="text-left text-sm font-bold mb-1">Botones de Puntos</div>
                        <div id="points-container" class="bg-gray-50 p-2 rounded mb-4 max-h-40 overflow-y-auto">${pointsList}</div>
                        <button onclick="app.addPreset('points')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded mb-4">+ Agregar Bot√≥n</button>

                        <div class="text-left text-sm font-bold mb-1">Art√≠culos de Tienda</div>
                        <div id="shop-container" class="bg-gray-50 p-2 rounded max-h-40 overflow-y-auto">${shopList}</div>
                        <button onclick="app.addPreset('shop')" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">+ Agregar Art√≠culo</button>
                    `,
                    confirmButtonText: 'Guardar Cambios',
                    showCancelButton: true,
                    preConfirm: () => {
                        // Recolectar datos manuales de los inputs
                        const newPoints = [];
                        const newShop = [];
                        // Logica simplificada: Para guardar ediciones reales, necesitamos leer los inputs generados
                        // Dado que Swal cierra el DOM, lo mejor en una app simple es borrar y re-agregar, 
                        // pero aqu√≠ intentaremos leer los inputs por ID antes de cerrar.
                        
                        this.data.config.points.forEach((_, i) => {
                            const icon = document.getElementById(`p-icon-${i}`)?.value;
                            const label = document.getElementById(`p-label-${i}`)?.value;
                            const val = document.getElementById(`p-val-${i}`)?.value;
                            if(icon && label) newPoints.push({icon, label, val: parseInt(val)});
                        });

                        this.data.config.shop.forEach((_, i) => {
                            const icon = document.getElementById(`s-icon-${i}`)?.value;
                            const name = document.getElementById(`s-name-${i}`)?.value;
                            const cost = document.getElementById(`s-cost-${i}`)?.value;
                            if(icon && name) newShop.push({icon, name, cost: parseInt(cost)});
                        });

                        return { points: newPoints, shop: newShop };
                    }
                });

                if(isConfirmed) {
                    // Nota: Swal preConfirm devuelve los datos en result.value
                    // Pero debido a la complejidad de leer inputs din√°micos en Swal, 
                    // si editaste texto en el modal, el preConfirm de arriba lo captura.
                    // Si agregaste items nuevos via 'app.addPreset', esos ya modificaron this.data.
                    // Aqu√≠ solo guardamos y recargamos.
                    this.sync();
                    Swal.fire('Guardado', 'Configuraci√≥n actualizada', 'success');
                }
            },
            
            // Auxiliares para Configurar Premios
            delPreset: function(type, idx) {
                this.data.config[type].splice(idx, 1);
                // Truco: Forzamos update del modal cerrando y reabriendo (r√°pido y sucio pero funciona)
                Swal.close(); setTimeout(() => this.configRewards(), 100);
            },
            addPreset: function(type) {
                if(type === 'points') this.data.config.points.push({ label: 'Nuevo', val: 10, icon: '‚≠ê' });
                if(type === 'shop') this.data.config.shop.push({ name: 'Nuevo √çtem', cost: 50, icon: 'üéÅ' });
                Swal.close(); setTimeout(() => this.configRewards(), 100);
            },


            // --- UTILS B√ÅSICOS ---
            addSubject: async function() {
                const {value:n} = await Swal.fire({input:'text', title:'Nombre de la Clase'});
                if(n) {
                    const c = ['blue','green','purple','yellow','red','indigo'];
                    this.data.subjects.push({ id:'s-'+Date.now(), name:n, color:c[this.data.subjects.length%c.length] });
                    this.sync(); this.nav('classes');
                }
            },
            addStudent: async function(sId) {
                const {value:n} = await Swal.fire({input:'text', title:'Nombre Alumno'});
                if(n) {
                    this.data.students.push({ id:'st-'+Date.now(), name:n, subjectId:sId, xp:0, wallet:0 });
                    this.sync(); this.nav('classDetail', sId);
                }
            },
            saveSettings: function() {
                this.data.settings.name = document.getElementById('set-name').value;
                this.sync();
            },
            exportExcel: function() {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.students), "Alumnos");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.rewardsLog), "Historial Puntos");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.behavior), "Conducta");
                XLSX.writeFile(wb, "TeacherApp_Data.xlsx");
            },
            resetAll: function() {
                Swal.fire({title:'¬øBorrar TODO?', icon:'warning', showCancelButton:true, confirmButtonText:'S√≠, borrar'}).then(r=>{
                    if(r.isConfirmed) { this.data = JSON.parse(JSON.stringify(DB_TEMPLATE)); this.sync(); location.reload(); }
                });
            },
            lock: function() { document.getElementById('lock-screen').classList.remove('hidden'); },
            unlock: function() { 
                const p = document.getElementById('pin-input').value; 
                if(p === this.data.settings.pin) document.getElementById('lock-screen').classList.add('hidden'); 
                else Swal.fire('Error', 'PIN Incorrecto', 'error');
            }
        };

        window.onload = () => App.init();
        window.app = App;
    </script>
</body>
</html>