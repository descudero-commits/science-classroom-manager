<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher App - Cloud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#3B82F6', secondary: '#10B981', dark: '#1F2937' } } }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .student-card.selected { border: 2px solid #3B82F6; background-color: #EFF6FF; }
        /* Animación de carga */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3B82F6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r flex-col hidden md:flex z-20">
        <div class="h-16 flex items-center justify-center border-b font-bold text-xl tracking-wider text-blue-600">
            TEACHER<span class="text-gray-800">APP</span>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="app.nav('dashboard')" class="w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center gap-3">
                <i class="fa-solid fa-chart-pie text-blue-500"></i> Dashboard
            </button>
            <button onclick="app.nav('students')" class="w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center gap-3">
                <i class="fa-solid fa-users text-green-500"></i> Alumnos
            </button>
            <button onclick="app.nav('planner')" class="w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center gap-3">
                <i class="fa-solid fa-calendar text-purple-500"></i> Planificación
            </button>
            <div class="mt-8 pt-4 border-t">
                <p class="text-xs text-gray-400 uppercase font-bold mb-2">Sistema</p>
                <button onclick="app.saveData(false)" class="w-full text-left p-3 rounded hover:bg-gray-100 transition flex items-center gap-3 text-sm">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Forzar Guardado
                </button>
            </div>
        </nav>
        <div id="status-bar" class="p-2 bg-gray-800 text-white text-xs text-center">
            Iniciando sistema...
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen relative">
        <header class="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-10">
            <div class="flex items-center gap-3">
                <button class="md:hidden text-gray-600" onclick="document.querySelector('aside').classList.toggle('hidden')">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="font-bold text-lg">Cargando...</h2>
            </div>
            <div id="loading-indicator" class="loader opacity-0 transition-opacity"></div>
        </header>

        <div id="view-container" class="flex-1 overflow-auto p-6 relative">
            <div class="flex items-center justify-center h-full text-gray-400">
                <div class="text-center">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-blue-500"></i>
                    <p>Conectando con tu nube...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        //  TU CONFIGURACIÓN (MODIFICAR ESTO)
        // ==========================================
        const PANTRY_ID = '9df76c09-c878-45e6-9df9-7b02d9cd00ef'; 
        const BASKET_NAME = 'teacher_v2';
        // ==========================================

        const App = {
            data: {
                db: null,
                view: 'dashboard',
                selectedStudents: [],
                currentClass: null
            },

            // 1. INICIALIZACIÓN ROBUSTA
            init: async function() {
                this.updateStatus('Conectando...', 'bg-yellow-600');
                
                // Verificación de seguridad del ID
                if(PANTRY_ID === 'PON_AQUI_TU_ID_REAL' || PANTRY_ID.length < 5) {
                    this.showErrorConfig();
                    return;
                }

                await this.loadFromCloud();
            },

            // 2. CONEXIÓN A PANTRY (NUBE)
            loadFromCloud: async function() {
                this.loading(true);
                try {
                    const url = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`;
                    const res = await fetch(url);
                    
                    if (res.ok) {
                        this.data.db = await res.json();
                        this.updateStatus('En línea', 'bg-green-600');
                        this.nav('dashboard');
                    } else {
                        // Si no existe la cesta, creamos una nueva
                        console.warn("Cesta no encontrada, creando nueva...");
                        this.data.db = this.getSchema();
                        await this.saveData(true); // Guardado inicial silencioso
                        this.nav('dashboard');
                    }
                } catch (error) {
                    console.error(error);
                    this.updateStatus('Error de Conexión', 'bg-red-600');
                    Swal.fire('Error', 'No se pudo conectar a Pantry. Revisa tu internet o tu ID.', 'error');
                } finally {
                    this.loading(false);
                }
            },

            saveData: async function(silent = false) {
                if(!silent) this.loading(true);
                this.updateStatus('Guardando...', 'bg-blue-600');
                
                try {
                    const url = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`;
                    await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data.db)
                    });
                    this.updateStatus('Guardado y Sincronizado', 'bg-green-600');
                    if(!silent) Swal.fire({ icon: 'success', title: 'Guardado', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                } catch (error) {
                    this.updateStatus('Fallo al guardar', 'bg-red-600');
                    if(!silent) Swal.fire('Error', 'No se pudieron guardar los cambios.', 'error');
                } finally {
                    if(!silent) this.loading(false);
                }
            },

            // 3. NAVEGACIÓN
            nav: function(viewName, param = null) {
                this.data.view = viewName;
                this.data.selectedStudents = []; // Limpiar selecciones
                const container = document.getElementById('view-container');
                const title = document.getElementById('page-title');

                // Renderizar vista correspondiente
                if (viewName === 'dashboard') {
                    title.innerText = 'Dashboard General';
                    this.renderDashboard(container);
                } else if (viewName === 'students') {
                    title.innerText = 'Gestión de Alumnos';
                    this.renderStudents(container);
                } else if (viewName === 'planner') {
                    title.innerText = 'Planificador';
                    this.renderPlanner(container);
                } else if (viewName === 'class') {
                    this.data.currentClass = param;
                    const materia = this.data.db.materias.find(m => m.id === param);
                    title.innerText = `Clase: ${materia.name}`;
                    this.renderClassMode(container, materia);
                }
            },

            // 4. RENDERIZADORES (VISTAS)
            renderDashboard: function(c) {
                c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in">
                        ${this.data.db.materias.map(m => `
                            <div onclick="app.nav('class', '${m.id}')" class="bg-white p-6 rounded-xl shadow cursor-pointer card-hover border-t-4 ${m.color.replace('bg-', 'border-')}">
                                <h3 class="font-bold text-xl mb-2">${m.name}</h3>
                                <p class="text-gray-500 text-sm">Toca para entrar a clase</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderStudents: function(c) {
                c.innerHTML = `
                    <div class="bg-white rounded-xl shadow p-6">
                        <button onclick="app.addStudent()" class="bg-blue-600 text-white px-4 py-2 rounded mb-4 hover:bg-blue-700 transition"><i class="fa-solid fa-plus"></i> Nuevo Alumno</button>
                        <div class="overflow-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-3">Nombre</th><th class="p-3">Materia</th><th class="p-3 text-right">Acción</th></tr></thead>
                                <tbody>
                                    ${this.data.db.alumnos.map(a => {
                                        const mat = this.data.db.materias.find(m => m.id === a.materiaId);
                                        return `<tr class="border-b hover:bg-gray-50">
                                            <td class="p-3 font-medium">${a.nombre}</td>
                                            <td class="p-3"><span class="px-2 py-1 rounded text-xs text-white ${mat ? mat.color : 'bg-gray-400'}">${mat ? mat.name : '?'}</span></td>
                                            <td class="p-3 text-right"><button onclick="app.delStudent('${a.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            renderPlanner: function(c) {
                c.innerHTML = `
                    <div class="bg-white rounded-xl shadow p-6">
                        <button onclick="app.addPlan()" class="bg-purple-600 text-white px-4 py-2 rounded mb-4 hover:bg-purple-700 transition"><i class="fa-solid fa-plus"></i> Nuevo Evento</button>
                        <div class="space-y-3">
                            ${this.data.db.planificacion.length === 0 ? '<p class="text-gray-400">No hay planes.</p>' : ''}
                            ${this.data.db.planificacion.map(p => `
                                <div class="flex justify-between items-center p-3 border rounded hover:bg-gray-50">
                                    <div>
                                        <div class="font-bold">${p.tema}</div>
                                        <div class="text-xs text-gray-500"><i class="fa-regular fa-calendar"></i> ${p.fecha}</div>
                                    </div>
                                    <button onclick="app.delPlan('${p.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderClassMode: function(c, materia) {
                const alumnos = this.data.db.alumnos.filter(a => a.materiaId === materia.id);
                const ptsBtn = this.data.selectedStudents.length > 0 
                    ? `<button onclick="app.givePoints()" class="fixed bottom-8 right-8 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:scale-110 transition animate-bounce z-50"><i class="fa-solid fa-star text-xl"></i></button>` 
                    : '';

                c.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pb-20">
                        ${alumnos.map(a => {
                            const isSel = this.data.selectedStudents.includes(a.id);
                            // Calcular puntos totales
                            const total = this.data.db.log.filter(l => l.studentId === a.id).reduce((sum, l) => sum + l.pts, 0);
                            
                            return `
                            <div onclick="app.toggleSel('${a.id}')" class="student-card ${isSel ? 'selected' : ''} bg-white p-4 rounded-xl shadow cursor-pointer relative transition-all">
                                <div class="font-bold text-gray-800">${a.nombre}</div>
                                <div class="mt-2 text-2xl font-bold text-yellow-500"><i class="fa-solid fa-star text-sm"></i> ${total}</div>
                                ${isSel ? '<div class="absolute top-2 right-2 text-blue-500"><i class="fa-solid fa-circle-check"></i></div>' : ''}
                            </div>`;
                        }).join('')}
                    </div>
                    ${ptsBtn}
                `;
            },

            // 5. ACCIONES DE USUARIO
            toggleSel: function(id) {
                if(this.data.selectedStudents.includes(id)) 
                    this.data.selectedStudents = this.data.selectedStudents.filter(s => s !== id);
                else 
                    this.data.selectedStudents.push(id);
                
                this.renderClassMode(document.getElementById('view-container'), this.data.db.materias.find(m => m.id === this.data.currentClass));
            },

            givePoints: async function() {
                const { value: pts } = await Swal.fire({ 
                    title: 'Asignar Puntos', 
                    input: 'number', 
                    inputValue: 1, 
                    text: `A ${this.data.selectedStudents.length} alumnos seleccionados`
                });
                if (pts) {
                    const puntos = parseInt(pts);
                    this.data.selectedStudents.forEach(id => {
                        this.data.db.log.push({ id: Date.now() + Math.random(), studentId: id, pts: puntos, date: new Date().toISOString() });
                    });
                    this.data.selectedStudents = [];
                    await this.saveData(); // Guardar en nube
                    this.renderClassMode(document.getElementById('view-container'), this.data.db.materias.find(m => m.id === this.data.currentClass));
                }
            },

            addStudent: async function() {
                const { value: form } = await Swal.fire({
                    title: 'Nuevo Alumno',
                    html: `<input id="sw1" class="swal2-input" placeholder="Nombre"><select id="sw2" class="swal2-input">${this.data.db.materias.map(m=>`<option value="${m.id}">${m.name}</option>`)}</select>`,
                    preConfirm: () => [document.getElementById('sw1').value, document.getElementById('sw2').value]
                });
                if(form && form[0]) {
                    this.data.db.alumnos.push({ id: 's-' + Date.now(), nombre: form[0], materiaId: form[1] });
                    this.saveData();
                    this.nav('students');
                }
            },

            delStudent: function(id) {
                this.data.db.alumnos = this.data.db.alumnos.filter(a => a.id !== id);
                this.saveData();
                this.nav('students');
            },

            addPlan: async function() {
                const { value: form } = await Swal.fire({
                    title: 'Planificar',
                    html: `<input id="p1" class="swal2-input" placeholder="Tema"><input id="p2" type="date" class="swal2-input">`,
                    preConfirm: () => ({ tema: document.getElementById('p1').value, fecha: document.getElementById('p2').value })
                });
                if(form.tema) {
                    this.data.db.planificacion.push({ id: 'p-' + Date.now(), ...form });
                    this.saveData();
                    this.nav('planner');
                }
            },

            delPlan: function(id) {
                this.data.db.planificacion = this.data.db.planificacion.filter(p => p.id !== id);
                this.saveData();
                this.nav('planner');
            },

            // HELPERS
            loading: function(show) {
                const loader = document.getElementById('loading-indicator');
                if(show) loader.classList.remove('opacity-0');
                else loader.classList.add('opacity-0');
            },
            
            updateStatus: function(text, colorClass) {
                const el = document.getElementById('status-bar');
                el.innerText = text;
                el.className = `p-2 text-white text-xs text-center transition-colors ${colorClass}`;
            },

            getSchema: function() {
                return {
                    materias: [
                        { id: "m1", name: "Matemáticas", color: "bg-blue-500" },
                        { id: "m2", name: "Ciencias", color: "bg-green-500" },
                        { id: "m3", name: "Historia", color: "bg-yellow-500" }
                    ],
                    alumnos: [],
                    planificacion: [],
                    log: []
                };
            },

            showErrorConfig: function() {
                document.getElementById('view-container').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-10 text-center">
                        <i class="fa-solid fa-triangle-exclamation text-6xl text-red-500 mb-4"></i>
                        <h2 class="text-2xl font-bold mb-2">Falta Configuración</h2>
                        <p class="mb-6">No has puesto tu ID de Pantry Cloud en el código.</p>
                        <div class="bg-gray-800 text-white p-4 rounded text-left font-mono text-sm w-full max-w-md">
                            1. Abre index.html<br>
                            2. Busca la línea 90<br>
                            3. Cambia 'PON_AQUI_TU_ID_REAL'<br>
                            4. Guarda y sube a GitHub
                        </div>
                    </div>
                `;
                this.updateStatus('Error: Falta ID', 'bg-red-600');
            }
        };

        // === PUNTO CRÍTICO PARA GITHUB ===
        // Esto expone la App al HTML globalmente
        window.app = App; 
        
        // Arrancar cuando el navegador esté listo
        window.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>